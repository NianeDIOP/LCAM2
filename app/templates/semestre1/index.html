{% extends 'with_sidebar.html' %}
{% block body_class %}theme-semestre1{% endblock %}

{% set title = 'Semestre 1' %}

{% block sidebar_content %}
    <a href="{{ url_for('semestre1.index', tab='overview') }}" class="list-group-item {% if active_tab == 'overview' %}active{% endif %}">
        <i class="fas fa-chart-pie"></i> Vue d'ensemble
    </a>
    <a href="{{ url_for('semestre1.index', tab='moyennes') }}" class="list-group-item {% if active_tab == 'moyennes' %}active{% endif %}">
        <i class="fas fa-chart-line"></i> Analyse des moyennes
    </a>
    <a href="{{ url_for('semestre1.index', tab='disciplines') }}" class="list-group-item {% if active_tab == 'disciplines' %}active{% endif %}">
        <i class="fas fa-book"></i> Analyse par discipline
    </a>
    <a href="{{ url_for('semestre1.index', tab='reports') }}" class="list-group-item {% if active_tab == 'reports' %}active{% endif %}">
        <i class="fas fa-file-alt"></i> Rapports
    </a>
    <a href="{{ url_for('semestre1.index', tab='import') }}" class="list-group-item {% if active_tab == 'import' %}active{% endif %}">
        <i class="fas fa-upload"></i> Importation
    </a>
    <div class="mt-4 px-3">
        <hr class="border-white opacity-25">
        <a href="{{ url_for('main.index') }}" class="list-group-item">
            <i class="fas fa-home"></i> Accueil
        </a>
        <a href="{{ url_for('admin.index') }}" class="list-group-item">
            <i class="fas fa-cog"></i> Paramètres
        </a>
    </div>
{% endblock %}

{% block main_content %}
{%- if active_tab == 'overview' -%}
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">Vue d'ensemble</h1>
            <p>{{ annee_scolaire }}</p>
        </div>
        <div>
            <select class="form-select form-select-sm" id="annee-selector">
                <option selected>{{ annee_scolaire }}</option>
            </select>
        </div>
    </div>

    <!-- Statistiques générales -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="stat-card">
                <div class="icon text-primary mb-3">
                    <i class="fas fa-user-graduate fa-2x"></i>
                </div>
                <div class="value text-primary">{{ stats.total_eleves }}</div>
                <div class="label">Élèves évalués</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card">
                <div class="icon text-info mb-3">
                    <i class="fas fa-calculator fa-2x"></i>
                </div>
                <div class="value text-info">{{ stats.moyenne_generale }}</div>
                <div class="label">Moyenne générale</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card">
                <div class="icon text-success mb-3">
                    <i class="fas fa-check-circle fa-2x"></i>
                </div>
                <div class="value text-success">{{ stats.eleves_moyenne }}</div>
                <div class="label">Élèves ≥ 10</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card">
                <div class="icon text-warning mb-3">
                    <i class="fas fa-award fa-2x"></i>
                </div>
                <div class="value text-warning">{{ stats.taux_reussite }}%</div>
                <div class="label">Taux de réussite</div>
            </div>
        </div>
    </div>

    <!-- Performance par niveau -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-layer-group me-2"></i>Performance par niveau</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Niveau</th>
                                    <th>Nombre d'élèves</th>
                                    <th>Moyenne générale</th>
                                    <th>Élèves ≥ 10</th>
                                    <th>Taux de réussite (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if niveau_stats %}
                                    {% for ns in niveau_stats %}
                                        <tr>
                                            <td>{{ ns.niveau }}</td>
                                            <td>{{ ns.nb_eleves }}</td>
                                            <td>{{ ns.moyenne }}</td>
                                            <td>{{ ns.nb_moyenne }}</td>
                                            <td>{{ ns.taux_reussite }}</td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center">Aucune donnée disponible</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{%- elif active_tab == 'moyennes' -%}
    {# Include the standalone Analyse des moyennes template with sidebar #}
    {% include 'semestre1/moyennes_analysis.html' %}
{%- elif active_tab == 'disciplines' -%}
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">Analyse par discipline</h1>
            <p>Performance par matière</p>
        </div>
        <div>
            <button class="btn btn-sm btn-outline-primary">
                <i class="fas fa-chart-bar me-1"></i> Graphiques
            </button>
        </div>
    </div>

    <!-- Filtre -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title"><i class="fas fa-filter me-2"></i>Filtrer les données</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="niveauDiscipline" class="form-label">Niveau</label>
                    <select class="form-select" id="niveauDiscipline" name="niveau_id">
                        <option value="">Tous les niveaux</option>
                        {% for niveau in niveaux %}
                            <option value="{{ niveau.id }}">{{ niveau.libelle }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="classeDiscipline" class="form-label">Classe</label>
                    <select class="form-select" id="classeDiscipline" name="classe_id" disabled>
                        <option value="">Sélectionner un niveau d'abord</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="discipline" class="form-label">Discipline</label>
                    <select class="form-select" id="discipline" name="discipline_id" disabled>
                        <option value="">Sélectionner une classe d'abord</option>
                    </select>
                </div>
                <div class="col-12 text-end">
                    <button type="button" class="btn btn-primary" id="btnFiltrerDisciplines">
                        <i class="fas fa-search me-2"></i>Filtrer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Zone des résultats de filtrage -->
    <div id="disciplinesStats" class="mb-4">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Veuillez sélectionner un niveau, une classe et une discipline pour afficher les statistiques
        </div>
    </div>

    <!-- Visualisations -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-book-open me-2"></i>Performance par Discipline</h5>
                </div>
                <div class="card-body text-center d-flex flex-column align-items-center justify-content-center">
                    <div class="icon text-primary mb-3">
                        <i class="fas fa-book-open fa-3x"></i>
                    </div>
                    <p>Sélectionnez des filtres pour afficher les performances par discipline</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-balance-scale me-2"></i>Comparaison entre Disciplines</h5>
                </div>
                <div class="card-body text-center d-flex flex-column align-items-center justify-content-center">
                    <div class="icon text-info mb-3">
                        <i class="fas fa-balance-scale fa-3x"></i>
                    </div>
                    <p>Sélectionnez des filtres pour afficher la comparaison entre disciplines</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tableau des résultats -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title"><i class="fas fa-table me-2"></i>Résultats par Discipline</h5>
            <div>
                <button type="button" class="btn btn-sm btn-outline-secondary me-2">
                    <i class="fas fa-print me-1"></i> Imprimer
                </button>
                <button type="button" class="btn btn-sm btn-outline-success">
                    <i class="fas fa-file-excel me-1"></i> Exporter Excel
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Discipline</th>
                            <th>Moyenne Générale</th>
                            <th>Minimum</th>
                            <th>Maximum</th>
                            <th>≥ 10/20</th>
                            <th>< 10/20</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <i class="fas fa-info-circle me-2"></i>
                                Sélectionnez des filtres pour afficher les résultats par discipline
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{%- elif active_tab == 'reports' -%}
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">Rapports</h1>
            <p>Bulletins et récapitulatifs</p>
        </div>
        <div>
            <button class="btn btn-sm btn-outline-primary">
                <i class="fas fa-print me-1"></i> Imprimer
            </button>
        </div>
    </div>

    <!-- Types de rapports -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title"><i class="fas fa-file-alt me-2"></i>Sélectionner un type de rapport</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="card h-100 border shadow-sm">
                        <div class="card-body text-center p-4">
                            <div class="icon text-primary mb-3">
                                <i class="fas fa-chalkboard-teacher fa-3x"></i>
                            </div>
                            <h5>Rapport de classe</h5>
                            <p class="small text-muted mb-3">Statistiques complètes pour une classe spécifique</p>
                            <button type="button" class="btn btn-primary btn-sm px-4">Sélectionner</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card h-100 border shadow-sm">
                        <div class="card-body text-center p-4">
                            <div class="icon text-success mb-3">
                                <i class="fas fa-book fa-3x"></i>
                            </div>
                            <h5>Rapport par discipline</h5>
                            <p class="small text-muted mb-3">Analyse détaillée d'une discipline particulière</p>
                            <button type="button" class="btn btn-success btn-sm px-4">Sélectionner</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card h-100 border shadow-sm">
                        <div class="card-body text-center p-4">
                            <div class="icon text-warning mb-3">
                                <i class="fas fa-trophy fa-3x"></i>
                            </div>
                            <h5>Tableau d'honneur</h5>
                            <p class="small text-muted mb-3">Liste des meilleurs élèves par classe ou niveau</p>
                            <button type="button" class="btn btn-warning btn-sm px-4">Sélectionner</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card h-100 border shadow-sm">
                        <div class="card-body text-center p-4">
                            <div class="icon text-info mb-3">
                                <i class="fas fa-chart-pie fa-3x"></i>
                            </div>
                            <h5>Rapport statistique global</h5>
                            <p class="small text-muted mb-3">Statistiques générales pour l'établissement</p>
                            <button type="button" class="btn btn-info btn-sm px-4">Sélectionner</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Information -->
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        Veuillez sélectionner un type de rapport pour continuer
    </div>
{%- elif active_tab == 'import' -%}
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">Importation</h1>
            <p>Données du semestre 1</p>
        </div>
        <div>
            <a href="#" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importHelpModal">
                <i class="fas fa-question-circle me-1"></i> Aide
            </a>
        </div>
    </div>

    <!-- Étapes d'importation -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="import-steps d-flex justify-content-between position-relative mb-5">
                <!-- Ligne de connexion -->
                <div class="import-line position-absolute" style="top: 25px; left: 50px; right: 50px; height: 2px; background-color: #e9ecef; z-index: 0;"></div>
                
                <!-- Étapes -->
                <div class="step-item text-center position-relative" style="z-index: 1;">
                    <div class="step-circle d-flex align-items-center justify-content-center mx-auto mb-2" 
                         style="width: 50px; height: 50px; border-radius: 50%; background-color: var(--primary); color: white;">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="step-label">Sélection</div>
                </div>
                
                <div class="step-item text-center position-relative" style="z-index: 1;">
                    <div class="step-circle d-flex align-items-center justify-content-center mx-auto mb-2" 
                         style="width: 50px; height: 50px; border-radius: 50%; background-color: #e9ecef; color: var(--gray-600);">
                        2
                    </div>
                    <div class="step-label">Import Excel</div>
                </div>
                
                <div class="step-item text-center position-relative" style="z-index: 1;">
                    <div class="step-circle d-flex align-items-center justify-content-center mx-auto mb-2" 
                         style="width: 50px; height: 50px; border-radius: 50%; background-color: #e9ecef; color: var(--gray-600);">
                        3
                    </div>
                    <div class="step-label">Visualisation</div>
                </div>
                
                <div class="step-item text-center position-relative" style="z-index: 1;">
                    <div class="step-circle d-flex align-items-center justify-content-center mx-auto mb-2" 
                         style="width: 50px; height: 50px; border-radius: 50%; background-color: #e9ecef; color: var(--gray-600);">
                        4
                    </div>
                    <div class="step-label">Validation</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire d'importation -->
    <form method="POST" action="{{ url_for('semestre1.import_data') }}" enctype="multipart/form-data">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title"><i class="fas fa-file-import me-2"></i>Importer des données</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="niveau_id" class="form-label">Niveau</label>
                        <select id="niveau_id" name="niveau_id" class="form-select" required>
                            <option value="">Sélectionner un niveau</option>
                            {% for niv in niveaux %}
                                <option value="{{ niv.id }}">{{ niv.libelle }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="classe_id" class="form-label">Classe</label>
                        <select id="classe_id" name="classe_id" class="form-select" required disabled>
                            <option value="">Sélectionner un niveau d'abord</option>
                        </select>
                    </div>
                    
                    <div class="col-12">
                        <label for="file" class="form-label">Fichier Excel (.xlsx)</label>
                        <input type="file" id="file" name="file" class="form-control" accept=".xlsx" required>
                        <div class="form-text">Le fichier doit contenir les feuilles "Moyennes eleves" et "Données détaillées"</div>
                    </div>
                    
                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload me-2"></i>Importer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Historique des imports -->
    <div id="import-history" class="card">
        <div class="card-header">
            <h5 class="card-title"><i class="fas fa-history me-2"></i>Historique des imports</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Niveau</th>
                            <th>Classe</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if imports %}
                            {% for imp in imports %}
                                <tr>
                                    <td>{{ imp.niveau }}</td>
                                    <td>{{ imp.classe }}</td>
                                    <td>
                                        <form method="POST" action="{{ url_for('semestre1.delete_import') }}" class="d-inline-block">
                                            <input type="hidden" name="niveau_id" value="{{ imp.niveau_id }}">
                                            <input type="hidden" name="classe_id" value="{{ imp.classe_id }}">
                                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirmAction('Êtes-vous sûr de vouloir supprimer cet import ?');">
                                                <i class="fas fa-trash-alt me-1"></i> Supprimer
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr></tr>
                                <td colspan="3" class="text-center py-4">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Aucun import enregistré
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{%- endif -%}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Créer les graphiques
        createCharts();
        
        // Gérer les interactions des filtres
        setupFilters();
        
        // setupTabs removed to allow full page reload for sidebar links

        // Auto-trigger filters for analysis tabs based on ?tab query param
        const urlParams = new URLSearchParams(window.location.search);
        const activeTabParam = urlParams.get('tab') || 'overview';
        if (activeTabParam === 'moyennes') {
            document.getElementById('btnFiltrerMoyennes')?.click();
        }
        if (activeTabParam === 'disciplines') {
            document.getElementById('btnFiltrerDisciplines')?.click();
        }
        // If landing with #import-history hash, scroll to history
        if (window.location.hash === '#import-history') {
            // Activer l'onglet import
            const tabLink = document.querySelector('.list-group-item[href*="tab=import"]');
            if (tabLink) {
                tabLink.click();
            }
            
            // Après un court délai pour laisser le temps à l'onglet de s'afficher, scroller vers l'historique
            setTimeout(function() {
                const historyElement = document.getElementById('import-history');
                if (historyElement) {
                    historyElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 300);
        }
    });
    
    // Créer les graphiques
    function createCharts() {
        // Créer le graphique des moyennes par niveau
        const moyennesNiveauCtx = document.getElementById('moyennesNiveauChart');
        if (moyennesNiveauCtx) {
            // Extraire les données des attributs data (si définis) ou utiliser des valeurs par défaut
            const labels = moyennesNiveauCtx.getAttribute('data-labels') ? 
                JSON.parse(moyennesNiveauCtx.getAttribute('data-labels')) : 
                [{% for ns in niveau_stats %}'{{ ns.niveau }}',{% endfor %}];
            
            const values = moyennesNiveauCtx.getAttribute('data-values') ? 
                JSON.parse(moyennesNiveauCtx.getAttribute('data-values')) : 
                [{% for ns in niveau_stats %}{{ ns.moyenne }},{% endfor %}];
            
            // Créer le graphique
            new Chart(moyennesNiveauCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Moyenne générale',
                        data: values,
                        backgroundColor: 'rgba(94, 53, 177, 0.7)',
                        borderColor: 'rgba(94, 53, 177, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 20
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        // Créer le graphique des taux de réussite par niveau
        const tauxReussiteCtx = document.getElementById('tauxReussiteChart');
        if (tauxReussiteCtx) {
            // Extraire les données des attributs data (si définis) ou utiliser des valeurs par défaut
            const labels = tauxReussiteCtx.getAttribute('data-labels') ? 
                JSON.parse(tauxReussiteCtx.getAttribute('data-labels')) : 
                [{% for ns in niveau_stats %}'{{ ns.niveau }}',{% endfor %}];
            
            const values = tauxReussiteCtx.getAttribute('data-values') ? 
                JSON.parse(tauxReussiteCtx.getAttribute('data-values')) : 
                [{% for ns in niveau_stats %}{{ ns.taux_reussite }},{% endfor %}];
            
            // Créer le graphique
            new Chart(tauxReussiteCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Taux de réussite (%)',
                        data: values,
                        backgroundColor: 'rgba(46, 204, 113, 0.7)',
                        borderColor: 'rgba(46, 204, 113, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }
    }
    
    // Configurer les filtres
    function setupFilters() {
        // Gestion des sélects dépendants niveau/classe
        setupNiveauClasseSelects('niveau', 'classe');
        setupNiveauClasseSelects('niveauDiscipline', 'classeDiscipline');
        setupNiveauClasseSelects('niveau_id', 'classe_id');
        
        // Gestion des sélects dépendants classe/discipline
        setupClasseDisciplineSelects('classeDiscipline', 'discipline');
        
        // Gestion du bouton de filtrage des moyennes
        const btnFiltrerMoyennes = document.getElementById('btnFiltrerMoyennes');
        if (btnFiltrerMoyennes) {
            btnFiltrerMoyennes.addEventListener('click', function() {
                filtrerMoyennes();
            });
        }
        
        // Gestion du bouton de filtrage des disciplines
        const btnFiltrerDisciplines = document.getElementById('btnFiltrerDisciplines');
        if (btnFiltrerDisciplines) {
            btnFiltrerDisciplines.addEventListener('click', function() {
                filtrerDisciplines();
            });
        }
    }
    
    // Configurer les sélects dépendants niveau/classe
    function setupNiveauClasseSelects(niveauId, classeId) {
        const niveauSelect = document.getElementById(niveauId);
        const classeSelect = document.getElementById(classeId);
        
        if (niveauSelect && classeSelect) {
            niveauSelect.addEventListener('change', function() {
                const niveauId = this.value;
                
                if (!niveauId) {
                    classeSelect.innerHTML = '<option value="">Sélectionner un niveau d\'abord</option>';
                    classeSelect.disabled = true;
                    return;
                }
                
                classeSelect.disabled = true;
                classeSelect.innerHTML = '<option value="">Chargement...</option>';
                
                fetch(`{{ url_for('semestre1.get_classes', niveau_id=0) }}`.replace('0', niveauId))
                    .then(response => response.json())
                    .then(data => {
                        classeSelect.innerHTML = '<option value="">Sélectionner une classe</option>';
                        
                        data.forEach(classe => {
                            const option = document.createElement('option');
                            option.value = classe.id;
                            option.textContent = classe.libelle;
                            classeSelect.appendChild(option);
                        });
                        
                        classeSelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Erreur lors du chargement des classes:', error);
                        classeSelect.innerHTML = '<option value="">Erreur de chargement</option>';
                        classeSelect.disabled = false;
                    });
            });
        }
    }
    
    // Configurer les sélects dépendants classe/discipline
    function setupClasseDisciplineSelects(classeId, disciplineId) {
        const classeSelect = document.getElementById(classeId);
        const disciplineSelect = document.getElementById(disciplineId);
        
        if (classeSelect && disciplineSelect) {
            classeSelect.addEventListener('change', function() {
                const classeId = this.value;
                
                if (!classeId) {
                    disciplineSelect.innerHTML = '<option value="">Sélectionner une classe d\'abord</option>';
                    disciplineSelect.disabled = true;
                    return;
                }
                
                disciplineSelect.disabled = true;
                disciplineSelect.innerHTML = '<option value="">Chargement...</option>';
                
                fetch(`{{ url_for('semestre1.get_disciplines', classe_id=0) }}`.replace('0', classeId))
                    .then(response => response.json())
                    .then(data => {
                        disciplineSelect.innerHTML = '<option value="">Sélectionner une discipline</option>';
                        
                        data.forEach(discipline => {
                            const option = document.createElement('option');
                            option.value = discipline.id;
                            option.textContent = discipline.libelle;
                            disciplineSelect.appendChild(option);
                        });
                        
                        disciplineSelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Erreur lors du chargement des disciplines:', error);
                        disciplineSelect.innerHTML = '<option value="">Erreur de chargement</option>';
                        disciplineSelect.disabled = false;
                    });
            });
        }
    }
    
    // Filtrer les moyennes
    function filtrerMoyennes() {
        const classeId = document.getElementById('classe').value;
        const moyennesStatsDiv = document.getElementById('moyennesStats');
        
        if (!classeId) {
            moyennesStatsDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Veuillez sélectionner une classe pour afficher les statistiques
                </div>
            `;
            return;
        }
        
        // Afficher un indicateur de chargement
        moyennesStatsDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Chargement des données...
            </div>
        `;
        
        // Appeler l'API pour récupérer les statistiques
        fetch(`{{ url_for('semestre1.stats_moyennes') }}?classe_id=${classeId}`)
            .then(response => response.json())
            .then(data => {
                // Afficher les statistiques
                moyennesStatsDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="stat-card">
                                <div class="icon text-primary mb-3">
                                    <i class="fas fa-user-graduate fa-2x"></i>
                                </div>
                                <div class="value text-primary">${data.total_eleves}</div>
                                <div class="label">Élèves évalués</div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card">
                                <div class="icon text-info mb-3">
                                    <i class="fas fa-calculator fa-2x"></i>
                                </div>
                                <div class="value text-info">${data.moyenne_generale}</div>
                                <div class="label">Moyenne générale</div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card">
                                <div class="icon text-success mb-3">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                                <div class="value text-success">${data.eleves_moyenne}</div>
                                <div class="label">Élèves ≥ 10</div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card">
                                <div class="icon text-warning mb-3">
                                    <i class="fas fa-award fa-2x"></i>
                                </div>
                                <div class="value text-warning">${data.taux_reussite}%</div>
                                <div class="label">Taux de réussite</div>
                            </div>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Erreur lors du chargement des statistiques:', error);
                moyennesStatsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Erreur lors du chargement des données. Veuillez réessayer.
                    </div>
                `;
            });
    }
    
    // Filtrer les disciplines
    function filtrerDisciplines() {
        const classeId = document.getElementById('classeDiscipline').value;
        const disciplineId = document.getElementById('discipline').value;
        const disciplinesStatsDiv = document.getElementById('disciplinesStats');
        
        if (!classeId || !disciplineId) {
            disciplinesStatsDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Veuillez sélectionner une classe et une discipline pour afficher les statistiques
                </div>
            `;
            return;
        }
        
        // Afficher un indicateur de chargement
        disciplinesStatsDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Chargement des données...
            </div>
        `;
        
        // Appeler l'API pour récupérer les statistiques
        fetch(`{{ url_for('semestre1.stats_discipline') }}?classe_id=${classeId}&discipline_id=${disciplineId}`)
            .then(response => response.json())
            .then(data => {
                // Afficher les statistiques
                disciplinesStatsDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-2 mb-3">
                            <div class="stat-card">
                                <div class="icon text-primary mb-3">
                                    <i class="fas fa-user-graduate fa-2x"></i>
                                </div>
                                <div class="value text-primary">${data.nb_eleves}</div>
                                <div class="label">Élèves</div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="stat-card">
                                <div class="icon text-info mb-3">
                                    <i class="fas fa-calculator fa-2x"></i>
                                </div>
                                <div class="value text-info">${data.moyenne_discipline}</div>
                                <div class="label">Moyenne</div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="stat-card">
                                <div class="icon text-success mb-3">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                                <div class="value text-success">${data.nb_moyenne}</div>
                                <div class="label">≥ 10</div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="stat-card">
                                <div class="icon text-warning mb-3">
                                    <i class="fas fa-award fa-2x"></i>
                                </div>
                                <div class="value text-warning">${data.taux_reussite}%</div>
                                <div class="label">Taux</div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="stat-card">
                                <div class="icon text-danger mb-3">
                                    <i class="fas fa-arrow-down fa-2x"></i>
                                </div>
                                <div class="value text-danger">${data.min}</div>
                                <div class="label">Min</div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="stat-card">
                                <div class="icon text-primary mb-3">
                                    <i class="fas fa-arrow-up fa-2x"></i>
                                </div>
                                <div class="value text-primary">${data.max}</div>
                                <div class="label">Max</div>
                            </div>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Erreur lors du chargement des statistiques:', error);
                disciplinesStatsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Erreur lors du chargement des données. Veuillez réessayer.
                    </div>
                `;
            });
    }
</script>
{% endblock %}