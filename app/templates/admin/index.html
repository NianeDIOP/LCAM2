{% extends 'base.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center bg-secondary text-white p-3 rounded shadow">
            <div>
                <h1 class="h3 mb-0">⚙️ Paramètres</h1>
                <p class="mb-0">Configuration et personnalisation de l'application</p>
            </div>
            <div>
                <a href="{{ url_for('main.index') }}" class="btn btn-sm btn-light">Accueil</a>
                <a href="{{ url_for('semestre1.index') }}" class="btn btn-sm btn-light">Semestre 1</a>
                <a href="{{ url_for('semestre2.index') }}" class="btn btn-sm btn-light">Semestre 2</a>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <ul class="nav nav-tabs" id="parametersTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="etablissement-tab" data-bs-toggle="tab" data-bs-target="#etablissement" type="button" role="tab" aria-controls="etablissement" aria-selected="true">
                    <i class="fas fa-school me-2"></i>Établissement
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="annee-tab" data-bs-toggle="tab" data-bs-target="#annee" type="button" role="tab" aria-controls="annee" aria-selected="false">
                    <i class="fas fa-calendar-alt me-2"></i>Année scolaire
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="niveaux-tab" data-bs-toggle="tab" data-bs-target="#niveaux" type="button" role="tab" aria-controls="niveaux" aria-selected="false">
                    <i class="fas fa-layer-group me-2"></i>Niveaux
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="classes-tab" data-bs-toggle="tab" data-bs-target="#classes" type="button" role="tab" aria-controls="classes" aria-selected="false">
                    <i class="fas fa-chalkboard me-2"></i>Classes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup" type="button" role="tab" aria-controls="backup" aria-selected="false">
                    <i class="fas fa-database me-2"></i>Sauvegarde
                </button>
            </li>
        </ul>
    </div>
</div>

<div class="tab-content" id="parametersTabContent">
    <!-- Informations de l'établissement -->
    <div class="tab-pane fade show active" id="etablissement" role="tabpanel" aria-labelledby="etablissement-tab">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">Informations de l'établissement</h5>
                    </div>
                    <div class="card-body">
                        <form action="{{ url_for('admin.update_etablissement') }}" method="post">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label for="nom_etablissement" class="form-label">Nom de l'établissement*</label>
                                    <input type="text" class="form-control" id="nom_etablissement" name="nom_etablissement" value="{{ config.nom_etablissement }}" required>
                                </div>
                                <div class="col-md-12">
                                    <label for="adresse" class="form-label">Adresse</label>
                                    <textarea class="form-control" id="adresse" name="adresse" rows="2">{{ config.adresse }}</textarea>
                                </div>
                                <div class="col-md-6">
                                    <label for="telephone" class="form-label">Téléphone</label>
                                    <input type="text" class="form-control" id="telephone" name="telephone" value="{{ config.telephone }}">
                                </div>
                                <div class="col-md-6">
                                    <label for="inspection_academique" class="form-label">Inspection d'académie</label>
                                    <input type="text" class="form-control" id="inspection_academique" name="inspection_academique" value="{{ config.inspection_academique }}">
                                </div>
                                <div class="col-md-12">
                                    <label for="inspection_education" class="form-label">Inspection de l'éducation et de la formation</label>
                                    <input type="text" class="form-control" id="inspection_education" name="inspection_education" value="{{ config.inspection_education }}">
                                </div>
                                <div class="col-12 d-grid gap-2 d-md-flex justify-content-md-end">
                                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gestion de l'année scolaire -->
    <div class="tab-pane fade" id="annee" role="tabpanel" aria-labelledby="annee-tab">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Gestion des années scolaires</h5>
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addAnneeModal">
                            <i class="fas fa-plus me-1"></i> Ajouter
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Libellé</th>
                                        <th>État</th>
                                        <th>Date début</th>
                                        <th>Date fin</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for annee in annees %}
                                    <tr>
                                        <td>{{ annee.id }}</td>
                                        <td>{{ annee.libelle }}</td>
                                        <td>
                                            {% if annee.etat == 'actif' %}
                                            <span class="badge bg-success">Actif</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Inactif</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ annee.date_debut }}</td>
                                        <td>{{ annee.date_fin }}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a href="{{ url_for('admin.set_active_annee', id=annee.id) }}" class="btn btn-outline-success" title="Définir comme active">
                                                    <i class="fas fa-check"></i>
                                                </a>
                                                <a href="{{ url_for('admin.edit_annee', id=annee.id) }}" class="btn btn-outline-primary" title="Éditer">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a href="{{ url_for('admin.delete_annee', id=annee.id) }}" class="btn btn-outline-danger" title="Supprimer" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette année scolaire?');">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center">Aucune année scolaire définie</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gestion des niveaux -->
    <div class="tab-pane fade" id="niveaux" role="tabpanel" aria-labelledby="niveaux-tab">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Gestion des niveaux scolaires</h5>
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addNiveauModal">
                            <i class="fas fa-plus me-1"></i> Ajouter
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Libellé</th>
                                        <th>État</th>
                                        <th>Classes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for niveau in niveaux %}
                                    <tr>
                                        <td>{{ niveau.id }}</td>
                                        <td>{{ niveau.libelle }}</td>
                                        <td>
                                            {% if niveau.etat == 'actif' %}
                                            <span class="badge bg-success">Actif</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Inactif</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ niveau.classes|length }}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a href="{{ url_for('admin.toggle_niveau', id=niveau.id) }}" class="btn btn-outline-success" title="Activer/Désactiver">
                                                    <i class="fas fa-toggle-on"></i>
                                                </a>
                                                <a href="{{ url_for('admin.edit_niveau', id=niveau.id) }}" class="btn btn-outline-primary" title="Éditer">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a href="{{ url_for('admin.delete_niveau', id=niveau.id) }}" class="btn btn-outline-danger" title="Supprimer" onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce niveau?');">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center">Aucun niveau défini</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gestion des classes -->
    <div class="tab-pane fade" id="classes" role="tabpanel" aria-labelledby="classes-tab">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Gestion des classes</h5>
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addClasseModal">
                            <i class="fas fa-plus me-1"></i> Ajouter
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="filterNiveau" class="form-label">Filtrer par niveau</label>
                            <select class="form-select" id="filterNiveau" onchange="filterClasses()">
                                <option value="all">Tous les niveaux</option>
                                {% for niveau in niveaux %}
                                <option value="{{ niveau.id }}">{{ niveau.libelle }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover" id="classesTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Niveau</th>
                                        <th>Libellé</th>
                                        <th>Effectif</th>
                                        <th>État</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for classe in classes %}
                                    <tr data-niveau="{{ classe.niveau_id }}">
                                        <td>{{ classe.id }}</td>
                                        <td>{{ classe.niveau.libelle }}</td>
                                        <td>{{ classe.libelle }}</td>
                                        <td>{{ classe.effectif }}</td>
                                        <td>
                                            {% if classe.etat == 'actif' %}
                                            <span class="badge bg-success">Actif</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Inactif</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a href="{{ url_for('admin.toggle_classe', id=classe.id) }}" class="btn btn-outline-success" title="Activer/Désactiver">
                                                    <i class="fas fa-toggle-on"></i>
                                                </a>
                                                <a href="{{ url_for('admin.edit_classe', id=classe.id) }}" class="btn btn-outline-primary" title="Éditer">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a href="{{ url_for('admin.delete_classe', id=classe.id) }}" class="btn btn-outline-danger" title="Supprimer" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette classe?');">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center">Aucune classe définie</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sauvegarde/Restauration -->
    <div class="tab-pane fade" id="backup" role="tabpanel" aria-labelledby="backup-tab">
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">Sauvegarde de la base de données</h5>
                    </div>
                    <div class="card-body">
                        <p>Créez une sauvegarde de la base de données pour conserver vos données en sécurité.</p>
                        <form action="{{ url_for('admin.create_backup') }}" method="post">
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-download me-2"></i>Créer une sauvegarde
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">Restauration de la base de données</h5>
                    </div>
                    <div class="card-body">
                        <p>Restaurez une sauvegarde précédente. <strong>Attention:</strong> cette action remplacera toutes les données actuelles.</p>
                        <form action="{{ url_for('admin.restore_backup') }}" method="post">
                            <div class="mb-3">
                                <label for="backupFile" class="form-label">Sélectionner une sauvegarde</label>
                                <select class="form-select" id="backupFile" name="backup_file" required>
                                    <option value="" selected disabled>Choisir une sauvegarde</option>
                                    {% for backup in backups %}
                                    <option value="{{ backup.filename }}">{{ backup.display_name }}</option>
                                    {% else %}
                                    <option value="" disabled>Aucune sauvegarde disponible</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-warning" onclick="return confirm('Êtes-vous sûr de vouloir restaurer cette sauvegarde? Toutes les données actuelles seront remplacées.');">
                                    <i class="fas fa-upload me-2"></i>Restaurer
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0 text-danger">Zone de danger</h5>
                    </div>
                    <div class="card-body">
                        <p>Les actions suivantes sont irréversibles et peuvent entraîner une perte de données.</p>
                        <form action="{{ url_for('admin.reset_database') }}" method="post" class="mb-3">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="confirmReset" name="confirm_reset" required>
                                <label class="form-check-label" for="confirmReset">
                                    Je comprends que cette action est irréversible et que toutes les données seront perdues.
                                </label>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-danger" onclick="return confirm('ATTENTION: Vous êtes sur le point de réinitialiser toute la base de données. Cette action est IRRÉVERSIBLE. Êtes-vous absolument sûr?');">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Réinitialiser la base de données
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ajouter Année Scolaire -->
<div class="modal fade" id="addAnneeModal" tabindex="-1" aria-labelledby="addAnneeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin.add_annee') }}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="addAnneeModalLabel">Ajouter une année scolaire</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="libelle" class="form-label">Libellé*</label>
                        <input type="text" class="form-control" id="libelle" name="libelle" placeholder="Ex: 2024-2025" required>
                    </div>
                    <div class="mb-3">
                        <label for="date_debut" class="form-label">Date de début</label>
                        <input type="date" class="form-control" id="date_debut" name="date_debut">
                    </div>
                    <div class="mb-3">
                        <label for="date_fin" class="form-label">Date de fin</label>
                        <input type="date" class="form-control" id="date_fin" name="date_fin">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="etat" name="etat" value="actif">
                        <label class="form-check-label" for="etat">
                            Définir comme année active
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Ajouter</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ajouter Niveau -->
<div class="modal fade" id="addNiveauModal" tabindex="-1" aria-labelledby="addNiveauModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin.add_niveau') }}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="addNiveauModalLabel">Ajouter un niveau scolaire</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="libelle_niveau" class="form-label">Libellé*</label>
                        <input type="text" class="form-control" id="libelle_niveau" name="libelle" placeholder="Ex: 6ème" required>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="etat_niveau" name="etat" value="actif" checked>
                        <label class="form-check-label" for="etat_niveau">
                            Actif
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Ajouter</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ajouter Classe -->
<div class="modal fade" id="addClasseModal" tabindex="-1" aria-labelledby="addClasseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin.add_classe') }}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="addClasseModalLabel">Ajouter une classe</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="niveau_id" class="form-label">Niveau*</label>
                        <select class="form-select" id="niveau_id" name="niveau_id" required>
                            <option value="" selected disabled>Sélectionner un niveau</option>
                            {% for niveau in niveaux %}
                            {% if niveau.etat == 'actif' %}
                            <option value="{{ niveau.id }}">{{ niveau.libelle }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="libelle_classe" class="form-label">Libellé*</label>
                        <input type="text" class="form-control" id="libelle_classe" name="libelle" placeholder="Ex: A" required>
                    </div>
                    <div class="mb-3">
                        <label for="effectif" class="form-label">Effectif estimé</label>
                        <input type="number" class="form-control" id="effectif" name="effectif" value="0" min="0">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="etat_classe" name="etat" value="actif" checked>
                        <label class="form-check-label" for="etat_classe">
                            Actif
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Ajouter</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function filterClasses() {
        const niveauId = document.getElementById('filterNiveau').value;
        const rows = document.querySelectorAll('#classesTable tbody tr');
        
        rows.forEach(row => {
            if (niveauId === 'all' || row.dataset.niveau === niveauId) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
</script>
{% endblock %}